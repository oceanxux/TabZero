name: Chrome Extension CI/CD

on:
  push:
    branches:
      - main # æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘è‡ªåŠ¨æ„å»ºï¼Œäº§ç‰©å­˜ä¸º Artifact
    tags:
      - 'v*.*.*' # æ¨é€ç‰ˆæœ¬æ ‡ç­¾ (ä¾‹å¦‚ v1.0.0, v2.3.4) æ—¶ï¼Œè§¦å‘æ„å»ºå¹¶åˆ›å»º Release
  workflow_dispatch: # å…è®¸ä½ æ‰‹åŠ¨åœ¨ GitHub é¡µé¢ä¸Šè¿è¡Œæ­¤å·¥ä½œæµ

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      # æˆäºˆå†™æƒé™ç»™ GITHUB_TOKENï¼Œç”¨äºåˆ›å»º Release
      contents: write 

    steps:
      - name: 1. Checkout code
        uses: actions/checkout@v4

      - name: 2. Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 

      - name: 3. Install dependencies (npm install)
        # ä½¿ç”¨ --legacy-peer-deps é¿å…æŸäº› peer dependency æŠ¥é”™
        run: npm install --legacy-peer-deps

      - name: 4. Run Build Command (tsc & vite build)
        # è¿è¡Œä½ çš„æ„å»ºå‘½ä»¤
        run: npm run build
        
      - name: 5. Archive Production Artifact (ZIP)
        # å°†æœ€ç»ˆçš„æ‰“åŒ…æ–‡ä»¶å¤¹ TabZero å‹ç¼©æˆ zip
        run: zip -r tabzero-release.zip TabZero/

      - name: 6. Upload Build Artifact (for manual download)
        uses: actions/upload-artifact@v4
        with:
          name: tabzero-extension-build
          path: tabzero-release.zip
          retention-days: 7 

      - name: 7. Create GitHub Release and Attach ZIP
        # ä»…å½“å·¥ä½œæµç”± "tag" æ¨é€è§¦å‘æ—¶æ‰è¿è¡Œæ­¤æ­¥éª¤
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: tabzero-release.zip # è‡ªåŠ¨å°† zip æ–‡ä»¶ä½œä¸ºé™„ä»¶
          draft: false # ç›´æ¥å‘å¸ƒ
          prerelease: false
          # ä½¿ç”¨æ ‡ç­¾åä½œä¸º Release æ ‡é¢˜
          name: Release ${{ github.ref_name }}
          body: |
            ğŸ‰ **æ–°ç‰ˆæœ¬å‘å¸ƒ**

            æ­¤ç‰ˆæœ¬åŒ…å«ä»¥ä¸‹æ„å»ºäº§ç‰©ï¼š
            - `tabzero-release.zip` (Chrome æ‰©å±•æ–‡ä»¶)